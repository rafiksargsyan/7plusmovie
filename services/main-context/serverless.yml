org: 7plusmovie
app: 7plusmovie
service: main-context
frameworkVersion: '3'
useDotenv: true

package:
  individually: true
  patterns:
    - '!node_modules/@aws-sdk/**'

provider:
  name: aws
  region: eu-west-3
  runtime: nodejs18.x
  iam:
    role:
      managedPolicies:
        - "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
        - "arn:aws:iam::aws:policy/AmazonS3FullAccess"
        - "arn:aws:iam::aws:policy/SecretsManagerReadWrite"
        - "arn:aws:iam::aws:policy/AWSLambda_FullAccess"
  stage: ${opt:stage}
  logRetentionInDays: 1

functions:
  createMovie:
    handler: src/core/app/createMovie.handler
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
      ALGOLIA_APP_ID: ${env:ALGOLIA_APP_ID}
      ALGOLIA_ALL_INDEX: ${env:ALGOLIA_ALL_INDEX}
      ALGOLIA_SEARCH_ONLY_KEY: ${env:ALGOLIA_SEARCH_ONLY_KEY}
    events:
      - http:
          integration: lambda
          path: /createMovie
          method: post
          request:
            template:
              application/json: '{ "originalLocale" : $input.json(''$.originalLocale''),
                                   "originalTitle" : $input.json(''$.originalTitle''),
                                   "releaseYear" : $input.json(''$.releaseYear'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  movieS3BucketTrigger:
    environment:
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID}
      R2_ACCESS_KEY_ID: ${env:R2_ACCESS_KEY_ID}
      CLOUDFLARE_ACCOUNT_ID: ${env:CLOUDFLARE_ACCOUNT_ID}
      CLOUDFLARE_CACHABLE_ACCOUNT_ID: ${env:CLOUDFLARE_CACHABLE_ACCOUNT_ID}
      ClOUDFLARE_MEDIA_ASSETS_R2_BUCKET: ${env:ClOUDFLARE_MEDIA_ASSETS_R2_BUCKET}
      ClOUDFLARE_MEDIA_ASSETS_CACHABLE_R2_BUCKET: ${env:ClOUDFLARE_MEDIA_ASSETS_CACHABLE_R2_BUCKET}
    handler: src/core/app/movieS3BucketTrigger.handler
    events:
      - s3:
          bucket: ${file(./.env.${sls:stage}.yml):MEDIA_ASSETS_S3_BUCKET}
          event: s3:ObjectCreated:*
          existing: true
    timeout: 60

  addPosterImagePortraitToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addPosterImagePortraitToMovie.handler
    events:
      - http:
          integration: lambda
          path: /addPosterImagePortraitToMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId''),
                                   "locale" : $input.json(''$.locale''),
                                   "relativePath" : $input.json(''$.relativePath'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addPosterImagePortraitToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addPosterImagePortraitToTvShow.handler
    events:
      - http:
          integration: lambda
          path: /addPosterImagePortraitToTvShow
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "locale" : $input.json(''$.locale''),
                                   "relativePath" : $input.json(''$.relativePath'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  movieUpdateHandler:
    handler: src/core/app/movieUpdateHandler.handler
    environment:
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID}
      ALGOLIA_APP_ID: ${env:ALGOLIA_APP_ID}
      ALGOLIA_ALL_INDEX: ${env:ALGOLIA_ALL_INDEX}
      MEDIA_ASSETS_S3_BUCKET: ${env:MEDIA_ASSETS_S3_BUCKET}
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    events:
      - stream: ${file(./.env.${sls:stage}.yml):DYNAMODB_MOVIE_STREAM_ARN}
  
  addTitleL8nToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addTitleL8nToMovie.handler
    events:
      - http:
          integration: lambda
          path: /addTitleL8nToMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId''),
                                   "locale" : $input.json(''$.locale''),
                                   "title" : $input.json(''$.title'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  createCloudFrontDistroMetadata:
    environment:
      DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME: ${env:DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME}
      TEST_FILE_PATH: ${env:TEST_FILE_PATH}
    handler: src/core/app/createCloudFrontDistroMetadata.handler
    role: createCloudFrontDistroMetadataRole
    events:
      - http:
          integration: lambda
          path: /createCloudFrontDistroMetadata
          method: post
          request:
            template:
              application/json: '{ "arn" : $input.json(''$.arn''),
                                   "assumeRoleArnForMainAccount" : $input.json(''$.assumeRoleArnForMainAccount''),
                                   "awsAccountNumber" : $input.json(''$.awsAccountNumber''),
                                   "signerKeyId" : $input.json(''$.signerKeyId'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  getMovieMetadataForPlayer:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
      DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME: ${env:DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME}
      CF_DISTRO_USAGE_THRESHOLD: ${env:CF_DISTRO_USAGE_THRESHOLD}
      CF_DISTRO_RANDOM_SELECTION_PROPORTION: ${env:CF_DISTRO_RANDOM_SELECTION_PROPORTION}
      CLOUDFLARE_MEDIA_ASSETS_DOMAIN: ${env:CLOUDFLARE_MEDIA_ASSETS_DOMAIN}
      CLOUDFLARE_MEDIA_ASSETS_CACHABLE_DOMAIN: ${env:CLOUDFLARE_MEDIA_ASSETS_CACHABLE_DOMAIN}
    handler: src/core/app/getMovieMetadataForPlayer.handler
    events:
      - http:
          integration: lambda
          path: /getMovieMetadataForPlayer/{id}
          method: get
          request:
            template:
              application/json: '{ "movieId" : "$input.params(''id'')",
                                   "preferredAudioLang" : "$util.escapeJavaScript($input.params().querystring.get(''preferredAudioLang''))",
                                   "releaseId" : "$util.escapeJavaScript($input.params().querystring.get(''releaseId''))" }'
              application/x-www-form-urlencoded: null
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
            template: '{ "subtitles" : $input.json(''$.subtitles''),
                         "mpdFile" : $input.json(''$.mpdFile''),
                         "m3u8File" : $input.json(''$.m3u8File''),
                         "backdropImage": $input.json(''$.backdropImage''),
                         "originalTitle": $input.json(''$.originalTitle''),
                         "titleL8ns": $input.json(''$.titleL8ns''),
                         "releaseYear": $input.json(''$.releaseYear''),
                         "thumbnailsFile": $input.json(''$.thumbnailsFile'') }'
  
  getMovieReleases:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/getMovieReleases.handler
    events:
      - http:
          integration: lambda
          path: /movie/{id}/releases
          method: get
          request:
            template:
              application/json: '{ "movieId" : "$input.params(''id'')",
                                   "preferredAudioLang" : "$util.escapeJavaScript($input.params().querystring.get(''preferredAudioLang''))" }'
              application/x-www-form-urlencoded: null
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
  
  getTvShowReleases:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/getTvShowReleases.handler
    events:
      - http:
          integration: lambda
          path: /tv-show/{id}/releases
          method: get
          request:
            template:
              application/json: '{ "id" : "$input.params(''id'')",
                                   "preferredAudioLang" : "$util.escapeJavaScript($input.params().querystring.get(''preferredAudioLang''))" }'
              application/x-www-form-urlencoded: null
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"

  addBackdropImageToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addBackdropImageToMovie.handler
    events:
      - http:
          integration: lambda
          path: /addBackdropImageToMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId''),
                                   "relativePath" : $input.json(''$.relativePath'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addGenreToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addGenreToMovie.handler
    events:
      - http:
          integration: lambda
          path: /addGenreToMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId''),
                                   "genre" : $input.json(''$.genre'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  addActorToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addActorToMovie.handler
    events:
      - http:
          integration: lambda
          path: /addActorToMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId''),
                                   "actor" : $input.json(''$.actor'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  addDirectorToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addDirectorToMovie.handler
    events:
      - http:
          integration: lambda
          path: /addDirectorToMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId''),
                                   "director" : $input.json(''$.director'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  touchMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/touchMovie.handler
    events:
      - http:
          integration: lambda
          path: /touchMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addTheMovieDbIdToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addTheMovieDbIdToMovie.handler
    events:
      - http:
          integration: lambda
          path: /addTheMovieDbIdToMovie
          method: patch
          request:
            template:
              application/json: '{ "movieId" : $input.json(''$.movieId''),
                                   "tmdbId" : $input.json(''$.tmdbId'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  movieTranscodingJobUpdateHandler:
    handler: src/core/app/movieTranscodingJobUpdateHandler.handler
    environment:
      TRANSCODING_CONTEXT_JOB_CREATION_LAMBDA_NAME: ${env:TRANSCODING_CONTEXT_JOB_CREATION_LAMBDA_NAME}
      DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME}
    events:
      - stream: ${file(./.env.${sls:stage}.yml):DYNAMODB_MOVIE_TRANSCODING_JOB_STREAM_ARN}

  createMovieTranscodingJob:
    handler: src/core/app/createMovieTranscodingJob.handler
    environment:
      DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME}
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    events:
      - http:
          integration: lambda
          path: /createMovieTranscodingJob
          method: post
          request:
            template:
              application/json: '$input.json(''$'')'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  transcodingJobCompletionHook:
    handler: src/core/app/transcodingJobCompletionHook.handler
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
      DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME}
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}    
      DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME}
      MEDIA_ASSETS_S3_BUCKET: ${env:MEDIA_ASSETS_S3_BUCKET}
      ClOUDFLARE_MEDIA_ASSETS_R2_BUCKET: ${env:ClOUDFLARE_MEDIA_ASSETS_R2_BUCKET}
      ClOUDFLARE_MEDIA_ASSETS_CACHABLE_R2_BUCKET: ${env:ClOUDFLARE_MEDIA_ASSETS_CACHABLE_R2_BUCKET}
      CLOUDFLARE_ACCOUNT_ID: ${env:CLOUDFLARE_ACCOUNT_ID}
      CLOUDFLARE_CACHABLE_ACCOUNT_ID: ${env:CLOUDFLARE_CACHABLE_ACCOUNT_ID}
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID}
    timeout: 300

  createTvShow:
    handler: src/core/app/tv-show/createTvShow.handler
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
      ALGOLIA_APP_ID: ${env:ALGOLIA_APP_ID}
      ALGOLIA_ALL_INDEX: ${env:ALGOLIA_ALL_INDEX}
      ALGOLIA_SEARCH_ONLY_KEY: ${env:ALGOLIA_SEARCH_ONLY_KEY}
    events:
      - http:
          integration: lambda
          path: /createTvShow
          method: post
          request:
            template:
              application/json: '{ "originalLocale" : $input.json(''$.originalLocale''),
                                   "originalTitle" : $input.json(''$.originalTitle''),
                                   "releaseYear" : $input.json(''$.releaseYear'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  addBackdropImageToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addBackdropImageToTvShow.handler
    events:
      - http:
          integration: lambda
          path: /addBackdropImageToTvShow
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "relativePath" : $input.json(''$.relativePath'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addGenreToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addGenreToTvShow.handler
    events:
      - http:
          integration: lambda
          path: /addGenreToTvShow
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "genre" : $input.json(''$.genre'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addTheMovieDbIdToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addTheMovieDbIdToTvShow.handler
    events:
      - http:
          integration: lambda
          path: /addTheMovieDbIdToTvShow
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "tmdbId" : $input.json(''$.tmdbId'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addTitleL8nToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addTitleL8nToTvShow.handler
    events:
      - http:
          integration: lambda
          path: /addTitleL8nToTvShow
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "locale" : $input.json(''$.locale''),
                                   "title" : $input.json(''$.title'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  getTvShowMetadataForPlayer:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
      DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME: ${env:DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME}
      CF_DISTRO_USAGE_THRESHOLD: ${env:CF_DISTRO_USAGE_THRESHOLD}
      CF_DISTRO_RANDOM_SELECTION_PROPORTION: ${env:CF_DISTRO_RANDOM_SELECTION_PROPORTION}
      CLOUDFLARE_MEDIA_ASSETS_DOMAIN: ${env:CLOUDFLARE_MEDIA_ASSETS_DOMAIN}
      CLOUDFLARE_MEDIA_ASSETS_CACHABLE_DOMAIN: ${env:CLOUDFLARE_MEDIA_ASSETS_CACHABLE_DOMAIN}
    handler: src/core/app/tv-show/getTvShowMetadataForPlayer.handler
    events:
      - http:
          integration: lambda
          path: /getTvShowMetadataForPlayer/{id}/{season}/{episode}
          method: get
          request:
            template:
              application/json: '{ "tvShowId" : "$input.params(''id'')",
                                   "season" : $input.params(''season''),
                                   "episode" : $input.params(''episode''),
                                   "preferredAudioLang" : "$util.escapeJavaScript($input.params().querystring.get(''preferredAudioLang''))",
                                   "releaseId" : "$util.escapeJavaScript($input.params().querystring.get(''releaseId''))" }'
              application/x-www-form-urlencoded: null
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
            template: '{ "subtitles" : $input.json(''$.subtitles''),
                         "mpdFile" : $input.json(''$.mpdFile''),
                         "m3u8File" : $input.json(''$.m3u8File''),
                         "stillImage": $input.json(''$.stillImage''),
                         "originalTitle": $input.json(''$.originalTitle''),
                         "titleL8ns": $input.json(''$.titleL8ns''),
                         "releaseYear": $input.json(''$.releaseYear''),
                         "seasonOriginalName": $input.json(''$.seasonOriginalName''),
                         "seasonNameL8ns": $input.json(''$.seasonNameL8ns''),
                         "episodeOriginalName": $input.json(''$.episodeOriginalName''),
                         "episodeNameL8ns": $input.json(''$.episodeNameL8ns''),
                         "thumbnailsFile": $input.json(''$.thumbnailsFile'') }'
  
  getTvShowForSeasonsListPage:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/getTvShowForSeasonsListPage.handler
    events:
      - http:
          integration: lambda
          path: /getTvShowForSeasonsListPage/{id}
          method: get
          request:
            template:
              application/json: '{ "tvShowId" : "$input.params(''id'')"}'
              application/x-www-form-urlencoded: null
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
            template: '{ "originalTitle": $input.json(''$.originalTitle''),
                         "titleL8ns": $input.json(''$.titleL8ns''),
                         "releaseYear": $input.json(''$.releaseYear''),
                         "posterImagesPortrait": $input.json(''$.posterImagesPortrait''),
                         "seasons": $input.json(''$.seasons'') }'
  
  createTvShowTranscodingJob:
    handler: src/core/app/tv-show/createTvShowTranscodingJob.handler
    environment:
      DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME}
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    events:
      - http:
          integration: lambda
          path: /createTvShowTranscodingJob
          method: post
          request:
            template:
              application/json: '$input.json(''$'')'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  tvShowUpdateHandler:
    handler: src/core/app/tv-show/tvShowUpdateHandler.handler
    environment:
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID}
      ALGOLIA_APP_ID: ${env:ALGOLIA_APP_ID}
      ALGOLIA_ALL_INDEX: ${env:ALGOLIA_ALL_INDEX}
      MEDIA_ASSETS_S3_BUCKET: ${env:MEDIA_ASSETS_S3_BUCKET}
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    events:
      - stream: ${file(./.env.${sls:stage}.yml):DYNAMODB_TV_SHOW_STREAM_ARN}
    timeout: 300

  tvShowTranscodingJobUpdateHandler:
    handler: src/core/app/tv-show/tvShowTranscodingJobUpdateHandler.handler
    environment:
      TRANSCODING_CONTEXT_JOB_CREATION_LAMBDA_NAME: ${env:TRANSCODING_CONTEXT_JOB_CREATION_LAMBDA_NAME}
      DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME}
    events:
      - stream: ${file(./.env.${sls:stage}.yml):DYNAMODB_TV_SHOW_TRANSCODING_JOB_STREAM_ARN}

  addSeasonToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addSeasonToTvShow.handler
    events:
      - http:
          integration: lambda
          path: /addSeasonToTvShow
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "seasonNumber" : $input.json(''$.seasonNumber''),
                                   "originalName" : $input.json(''$.originalName'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6 

  addEpisodeToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addEpisodeToTvShow.handler
    events:
      - http:
          integration: lambda
          path: /addEpisodeToTvShow
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "seasonNumber" : $input.json(''$.seasonNumber''),
                                   "originalName" : $input.json(''$.originalName''),
                                   "episodeNumber" : $input.json(''$.episodeNumber'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addTmdbSeasonNumber:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addTmdbSeasonNumber.handler
    events:
      - http:
          integration: lambda
          path: /addTmdbSeasonNumber
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "seasonNumber" : $input.json(''$.seasonNumber''),
                                   "tmdbSeasonNumber" : $input.json(''$.tmdbSeasonNumber'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  addTmdbEpisodeNumber:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addTmdbEpisodeNumber.handler
    events:
      - http:
          integration: lambda
          path: /addTmdbEpisodeNumber
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "seasonNumber" : $input.json(''$.seasonNumber''),
                                   "episodeNumber" : $input.json(''$.episodeNumber''),
                                   "tmdbEpisodeNumber" : $input.json(''$.tmdbEpisodeNumber'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  addEpisodesBasedOnTmdbSeasonNumber:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID}
    handler: src/core/app/tv-show/addEpisodesBasedOnTmdbSeasonNumber.handler
    events:
      - http:
          integration: lambda
          path: /addEpisodesBasedOnTmdbSeasonNumber
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : $input.json(''$.tvShowId''),
                                   "seasonNumber" : $input.json(''$.seasonNumber'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  cfDistroUsageUpdater:
    environment:
      DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME: ${env:DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME}
    handler: src/core/app/cfDistroUsageUpdater.handler
    role: createCloudFrontDistroMetadataRole
    events:
      - schedule: rate(${file(./.env.${sls:stage}.yml):CF_DISTRO_USAGE_UPDATE_INTERVAL_IN_MINUTES} minutes)
    timeout: 900

  addRICMovieIdToMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/addRICMovieIdToMovie.handler
    events:
      - http:
          integration: lambda
          path: /movie/{id}/ricId
          method: patch
          request:
            template:
              application/json: '{ "movieId" : "$input.params(''id'')",
                                   "ricId" : $input.json(''$.ricId'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  movieEnableMonitorReleases:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/movieEnableMonitorReleases.handler
    events:
      - http:
          integration: lambda
          path: /movie/{id}/enableMonitorReleases
          method: patch
          request:
            template:
              application/json: '{ "movieId" : "$input.params(''id'')" }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

  movieDisableMonitorReleases:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
    handler: src/core/app/movieDisableMonitorReleases.handler
    events:
      - http:
          integration: lambda
          path: /movie/{id}/disableMonitorReleases
          method: patch
          request:
            template:
              application/json: '{ "movieId" : "$input.params(''id'')" }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  movieNewReleaseChecker:
    environment:
      RIC_GET_MOVIE_LAMBDA_NAME: ${env:RIC_GET_MOVIE_LAMBDA_NAME}
      RAW_MEDIA_FILES_BASE_URL: ${env:RAW_MEDIA_FILES_BASE_URL}
      DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_MOVIE_TRANSCODING_JOB_TABLE_NAME}
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
      DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME: ${env:DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME}
      CF_DISTRO_USAGE_THRESHOLD: ${env:CF_DISTRO_USAGE_THRESHOLD}
      CF_DISTRO_RANDOM_SELECTION_PROPORTION: ${env:CF_DISTRO_RANDOM_SELECTION_PROPORTION}
    handler: src/core/app/movieNewReleaseChecker.handler
    events:
      - schedule: rate(${file(./.env.${sls:stage}.yml):MOVIE_NEW_RELEASE_CHECKER_INTERVAL_IN_MINUTES} minutes)
    timeout: 900

  deleteReleaseFromMovie:
    environment:
      DYNAMODB_MOVIE_TABLE_NAME: ${env:DYNAMODB_MOVIE_TABLE_NAME}
      MEDIA_ASSETS_S3_BUCKET: ${env:MEDIA_ASSETS_S3_BUCKET}
      ClOUDFLARE_MEDIA_ASSETS_R2_BUCKET: ${env:ClOUDFLARE_MEDIA_ASSETS_R2_BUCKET}
      CLOUDFLARE_ACCOUNT_ID: ${env:CLOUDFLARE_ACCOUNT_ID}
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID}
    handler: src/core/app/deleteReleaseFromMovie.handler
    events:
      - http:
          integration: lambda
          path: /movie/{id}/release/{releaseId}
          method: delete
          request:
            template:
              application/json: '{ "movieId" : "$input.params(''id'')",
                                   "releaseId" : "$input.params(''releaseId'')" }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
    timeout: 20

  tvShowConfigureReleasesMonitoring:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/configureReleaseMonitoring.handler
    events:
      - http:
          integration: lambda
          path: /tv-show/{id}/releaseMonitoring
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : "$input.params(''id'')",
                                   "seasonNumber" : $input.json(''$.seasonNumber''),
                                   "episodeNumber" : $input.json(''$.episodeNumber''),
                                   "releaseMonitoring" : $input.json(''$.releaseMonitoring'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  tvShowNewReleaseChecker:
    environment:
      RIC_GET_TVSHOW_SEASON_LAMBDA_NAME: ${env:RIC_GET_TVSHOW_SEASON_LAMBDA_NAME}
      RAW_MEDIA_FILES_BASE_URL: ${env:RAW_MEDIA_FILES_BASE_URL}
      DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME}
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
      DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME: ${env:DYNAMODB_CF_DISTRO_METADATA_TABLE_NAME}
      CF_DISTRO_USAGE_THRESHOLD: ${env:CF_DISTRO_USAGE_THRESHOLD}
      CF_DISTRO_RANDOM_SELECTION_PROPORTION: ${env:CF_DISTRO_RANDOM_SELECTION_PROPORTION}
    handler: src/core/app/tv-show/tvShowNewReleaseChecker.handler
    timeout: 120
    
  tvShowNewReleaseCheckerFanout:
    environment:
      RIC_GET_TVSHOW_SEASON_LAMBDA_NAME: ${env:RIC_GET_TVSHOW_SEASON_LAMBDA_NAME}
      RAW_MEDIA_FILES_BASE_URL: ${env:RAW_MEDIA_FILES_BASE_URL}
      DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TRANSCODING_JOB_TABLE_NAME}
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
      TVSHOW_NEW_RELEASE_CHECKER_LAMBDA: ${env:TVSHOW_NEW_RELEASE_CHECKER_LAMBDA}
    handler: src/core/app/tv-show/tvShowNewReleaseCheckerFanout.handler  
    events:
      - schedule: rate(${file(./.env.${sls:stage}.yml):MOVIE_NEW_RELEASE_CHECKER_INTERVAL_IN_MINUTES} minutes)
    timeout: 900

  addRICIdToTvShow:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/addRICTvShowId.handler
    events:
      - http:
          integration: lambda
          path: /tv-show/{id}/ricId
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : "$input.params(''id'')",
                                   "ricId" : $input.json(''$.ricId'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6
  
  ip2AudioLang:
    environment:
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID}
    handler: src/core/app/ip2AudioLang.handler
    events:
      - http:
          integration: lambda
          path: /ip-2-audio-lang/{ip}
          method: get
          request:
            template:
              application/json: '{ "ip" : "$input.params(''ip'')" }'
              application/x-www-form-urlencoded: null
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"

  tvShowTmdbSyncFanout:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
      TVSHOW_TMDB_SYNC_LAMBDA_NAME: ${env:TVSHOW_TMDB_SYNC_LAMBDA_NAME} 
    handler: src/core/app/tv-show/tvShowTmdbSyncFanout.handler
    events:
      - schedule: rate(${file(./.env.${sls:stage}.yml):TVSHOW_TMDB_SYNC_INTERVAL_IN_MINUTES} minutes)
    timeout: 900

  tvShowTmdbSync:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
      SECRET_MANAGER_SECRETS_ID: ${env:SECRET_MANAGER_SECRETS_ID} 
    handler: src/core/app/tv-show/tvShowTmdbSync.handler
    timeout: 120

  tvShowSetTmdbSyncEnabled:
    environment:
      DYNAMODB_TV_SHOW_TABLE_NAME: ${env:DYNAMODB_TV_SHOW_TABLE_NAME}
    handler: src/core/app/tv-show/tvShowSetTmdbSyncEnabled.handler
    events:
      - http:
          integration: lambda
          path: /tv-show/{id}/  
          method: patch
          request:
            template:
              application/json: '{ "tvShowId" : "$input.params(''id'')",
                                   "tmdbSyncEnabled" : $input.json(''$.tmdbSyncEnabled'') }'
              application/x-www-form-urlencoded: null
          authorizer:
            arn: arn:aws:cognito-idp:eu-west-3:003200941285:userpool/eu-west-3_K4C2mQvl6

resources:
  Resources:
    createCloudFrontDistroMetadataRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: createCloudFrontDistroMetadataRole_${sls:stage}
        ManagedPolicyArns:
          - "arn:aws:iam::aws:policy/AdministratorAccess"
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - 'sts:AssumeRole'

plugins:
  - serverless-esbuild

custom:
  esbuild:
    bundle: true
    minify: false
